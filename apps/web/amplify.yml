version: 1
applications:
  - appRoot: apps/web
    env:
      variables:
        #AMPLIFY_DIFF_DEPLOY: true
    backend:
      phases:
        build:
          commands:
            - echo BACKEND BUILD
            # We back out, copy the amplify config before build, move it into the monorepo root and call it a day.
            # We do this for all amplify envs as long as we deploy in a monorepo.
            # You might be asking "Why?" Well i'm sick of #current-backend bitching about missing deps so I made amplify it's own package and then I realized all
            # future packages should do the same and they can be copied to the projects they need to be copied to.
            - cd ../../
            - cd amplify
            - mv web/ ../apps/web/
            - cd ../
            - cd apps/web/
            - export NODE_OPTIONS="--max-old-space-size=8192"
            - amplifyPush --simple
    frontend:
      phases:
        preBuild:
          commands:
            - echo FRONTEND PREBUILD
            - cd ../../
            - npm ci
        build:
          commands:
            - echo FRONTEND BUILD
            - npm run build
            - cd apps/web
        postBuild:
          commands:
            - ls
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - ../node_modules/.cache/turbo
          - node_modules/**/*
